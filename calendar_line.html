
<!DOCTYPE html>
<meta charset="utf-8">
<html>

<head>
  <style>

    body {
      color: #1f3838;
      background-color: #fffafa;
      font-family: Arial, Helvetica, sans-serif;
      }

    .container {
      margin: 50px 24px;
      padding: 10px;
      }

    #menus {
      font-size: 12px;
      margin: 10px 20px;
      }

    #menus span, #menus span{
      display: inline-block;
      text-align: left;
      width: 90px;
      }


    .axis path {
      display: none;
      }

    .axis line {
      shape-rendering: crispEdges;
      stroke: #b7b3ae;
      /*stroke: #c4c0bc;*/
      }
/*
    .axis .minor line {
      stroke: #777;
      stroke-dasharray: 2,2;
      }
*/
    .axis text {
      display: none;
      }

    .calendar-month {
      fill: #b7b3ae;
      font-size: 10px;
      font-style: italic;
      font-family: serif;
      }

    #playground {
      }

    </style>

  </head>

<body>

  <div class="container">
    <svg id='playground'></svg>
    </div>  <!-- /container -->

  <script src="//d3js.org/d3.v4.min.js"></script>

<!-- - - - - - - - - - - - - - - BEGIN SCRIPT - - - - - - - - - - - - - - -->

<script>

  // Playground dimensions.
  var SVG_MARGINS = {'top': 40, 'right': 20, 'bottom': 20, 'left': 30};
  var SVG_SIZE = {
    'width': 1200,
    'height': 600  - SVG_MARGINS.top - SVG_MARGINS.bottom
    };

  // - - - - - - - - - - - - - - - -
  // Cell dimensions.
  var CELL_HEIGHT = 14;
  var CELL_WIDTH = 8;

  var GRID_COLOR = '#c4c0bc';

  // - - - - - - - - - - - - - - - -
  // Horizontal grouping - e.g. weeks.
  var CELL_GROUP_COUNT = 7;
  var CELL_GROUP_GAP = 6;

  // - - - - - - - - - - - - - - - -
  // Vertical groupings.
  var ROW_SPACING = 3;
  var ROW_BAND_COUNT = 3;
  var ROW_BAND_GAP = 8;

  // - - - - - - - - - - - - - - - -
  // Every N rows we include a reference "calendar".
  var ROW_CALENDAR_COUNT = 9;
  var ROW_CALENDAR_GAP = 12;

  // - - - - - - - - - - - - - - - -
  // Horizontal and vertical cell counts.
  var DATA_PER_ROW = 91;
  // var ROWS_COUNT = 9;
  var ROWS_COUNT = 25;

  // - - - - - - - - - - - - - - - -
  // We populate DATA_PER_ROW data elements starting from this value.
  var DATA_MIN = 6102;

  // The day of the week that a data value of 0 would land on.
  var DATA_0_WEEKDAY = 3;

  // The day of the week that the first actual data value (DATA_MIN) lands on.
  var DATA_MIN_WEEKDAY = (DATA_MIN + DATA_0_WEEKDAY) % CELL_GROUP_COUNT;

  // - - - - - - - - - - - - - - - -
  // We leave a small gap between Sunday and Monday days.
  var CELL_X_SCALE = d3.scaleOrdinal()
    .domain(
      Array(DATA_PER_ROW).fill(0).map(function(x, i){return i + DATA_MIN;})
      )
    .range(
      Array(DATA_PER_ROW).fill(0).map(function(x, i){
        return (
          CELL_WIDTH * i
          + CELL_GROUP_GAP * Math.floor(
            (i + DATA_MIN_WEEKDAY) / CELL_GROUP_COUNT
            )
          )
        })
      );

  // - - - - - - - - - - - - - - - -
  // We leave a small gap every ROW_BAND_COUNT rows, and a slightly
  // larger gap every ROW_CALENDAR_COUNT rows.
  var ROW_Y_SCALE = d3.scaleOrdinal()
    .domain(
      Array(ROWS_COUNT).fill(0).map(function(x, i){return i;})
      )
    .range(
      Array(ROWS_COUNT).fill(0).map(function(x, i){
        return (
          (CELL_HEIGHT + ROW_SPACING) * i
          + ROW_BAND_GAP * Math.floor(i / ROW_BAND_COUNT)
          + ROW_CALENDAR_GAP * Math.floor(i / ROW_CALENDAR_COUNT)
          )
        })
      );

  var MONTHSTARTS = getMonthStarts(DATA_MIN, DATA_PER_ROW);

  var CALENDAR_X_SCALE = d3.scaleOrdinal()
    .domain(MONTHSTARTS.map(function(x) {return x.value;}))
    .range(MONTHSTARTS.map(function(x) {return CELL_X_SCALE(x.value);}));
      
  // We'll set the domain size at run time.
  console.log(ROWS_COUNT);
  console.log(ROW_CALENDAR_COUNT);

  // If we have exactly enough rows to make up one calendar group, the
  // calendar row will have to be "added" at the bottom instead of
  // being positioned between two calendar groups. Hence we subtract
  // one from ROWS_COUNT.
  var nCalendarRows = Math.floor((ROWS_COUNT - 1)/ ROW_CALENDAR_COUNT);

  var CALENDAR_Y_SCALE = d3.scaleOrdinal()
    .domain(
      Array(nCalendarRows).fill(0).map(function(x, i){return i;})
      )
    .range(
      Array(nCalendarRows).fill(0).map(function(x, i){
        return (
          Math.floor(
            2 * CELL_HEIGHT + 
            ROW_Y_SCALE((i + 1) * ROW_CALENDAR_COUNT - 1)
            )
          );
        })
      );

  // Legacy...
  // var BAR_Y = d3.scalePoint();

  // - - - - - - - - - - - - - - - - - - - - - - - -
  // Initial rendering.
  // - - - - - - - - - - - - - - - - - - - - - - - -

  var PLAYGROUND = d3.select('#playground')
      .attr('width', SVG_SIZE.width)
      .attr('height', SVG_SIZE.height);
      // .style('border', '1px solid gray');

  // PLAYGROUND.append("rect")
  //   .attr('x', 1)
  //   .attr('y', 1)
  //   .attr('width', SVG_SIZE.width - 2)
  //   .attr('height', SVG_SIZE.height - 2)
  //   .style('stroke', 'blue')
  //   .style('fill', 'none')
  //   ;


  // populateAxes();
  
  redraw();

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // Populate an object with the data values that correspond to the start
  // and end of months.
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  function getMonthStarts(data_min, data_count) {

    // Calculate the msec-times for the first days of months in the data.

    day = 24 * 3600 * 1000;
    monthNames = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December',
      'January'
      ];  // January twice is intentional.

    monthStarts = new Array();

    baseDays = (new Date('2000/01/01')).getTime()/day;

    data_now = data_min;
    console.log('data_now: ' + data_now);

    date = new Date(day * (baseDays + data_now));
    console.log('start: ' + date.toDateString());

    year = date.getFullYear();
    month = date.getMonth() + 1;  // Remember, the months number 0-11.
    dom = date.getDate();

    // Did we happen to start on the first of the month?
    if (dom == 1) {
      monthStarts.push({'value': data_now, 'month': monthNames[month]});
      }
    console.log('----------------');
    while (true) {

      year = year + (month == 12 ? 1 : 0);
      month = (month == 12 ? 1 : month + 1);

      // console.log(year + '/' + month + '/01');
      date = new Date(year + '/' + month + '/01');
      console.log(date.toDateString());

      time = date.getTime();
      data_now = Math.floor(time / day - baseDays);
      console.log('data_now: ' + data_now);

      console.log('');
      if (data_now >= data_min + data_count) {break;}
      console.log(month);
      console.log(monthNames[month]);
      monthStarts.push({'value': data_now, 'month': monthNames[month]});

      }

    console.log('monthStarts: ' + monthStarts);
    console.log(monthStarts[0]);
    return monthStarts;


    }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // Redraw the dynamic elements.
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  function redraw() {

    var rowUpdate = PLAYGROUND.selectAll(".grid-row")
        .data(Array(ROWS_COUNT).fill(0));

    var rowEnter = rowUpdate.enter()
      .append('g')
        .attr('class', 'grid-row')
        .attr(
          'transform',
          function(d, i) {return 'translate(0, ' + ROW_Y_SCALE(i) + ')'}
          );

    var cellUpdate = rowEnter.selectAll('.grid-cell')
        .data(Array(DATA_PER_ROW).fill(0));

    var cellEnter = cellUpdate.enter()
      .append('g')
        .attr('class', 'grid-cell');

    cellEnter.append("rect")
        .attr("class", "grid-cell")
        .attr("width", CELL_WIDTH)
        .attr("height", CELL_HEIGHT)
        .attr('x',function(d, i) {
          // console.log(i + " " + CELL_X_SCALE(i));
          return CELL_X_SCALE(i);
          })
        .style('stroke', GRID_COLOR)
        .style('fill', 'none');

    // // temporary hack to see one.
    // var calendarUpdate = PLAYGROUND.selectAll(".calendar-row")
    //     .data(Array(2).fill(0));

    // var calendarEnter = calendarUpdate.enter()
    //   .append('g')
    //     .attr('class', 'calendar-row')
    //     .attr(
    //       'transform',
    //       function(d, i) {return 'translate(0, ' + CALENDAR_Y_SCALE(i) + ')'}
    //       )
    //     ;

    // calendarEnter.append("rect")
    //     .attr("class", "dummy")
    //     .attr("width", CELL_WIDTH + Math.max.apply(null, CELL_X_SCALE.range()))
    //     // .attr("width", 300)
    //     .attr("height", 1)
    //     .style('stroke', GRID_COLOR)
    //     // .style('fill', 'GRID_COLOR');
    //     .style('fill', 'none');

    // // AS AN AXIS?
    // var calendarAxis = d3.axisTop(CALENDAR_X_SCALE)
    //   .tickSize(180);

    // // // temporary hack to see one.
    // var calendarUpdate = PLAYGROUND.selectAll(".calendar-row")
    //     .data(Array(2).fill(0));

    // var calendarEnter = calendarUpdate.enter()
    //   .append('g')
    //     .attr("class", "calendar axis")
    //     .attr(
    //       'transform',
    //       function(d, i) {
    //         console.log('Y: ' + CALENDAR_Y_SCALE(i))
    //         return 'translate(0, ' + CALENDAR_Y_SCALE(i) + ')'
    //         }
    //       )
    //     .style('stroke', GRID_COLOR)
    //     .call(calendarAxis);

    var gridBottom = Math.max.apply(null, ROW_Y_SCALE.range());
    // console.log(gridBottom);
    var calendarBarBottom = gridBottom;
    var calendarRowY = CALENDAR_Y_SCALE.range();

    var nCalendarRows = CALENDAR_Y_SCALE.domain().length;
    // nCalendarRows = 0;
    // console.log('nCalendarGaps: ' + nCalendarRows);

    if (nCalendarRows == 0) {
      // We'll put in a "fake" one at the bottom.
      var calendarGapHeight = (
        ROW_BAND_GAP + ROW_CALENDAR_GAP + ROW_SPACING + CELL_HEIGHT
        );
      calendarBarBottom += calendarGapHeight;
      calendarRowY = [
        Math.max.apply(null, ROW_Y_SCALE.range()) + 2 * CELL_HEIGHT
        ];
      nCalendarRows = 1;
      }

    var calendarAxis = d3.axisTop(CALENDAR_X_SCALE)
        .tickSize(calendarBarBottom);

    PLAYGROUND.append('g')
        .attr("class", "calendar axis")
        .attr('transform', 'translate(0, ' + calendarBarBottom + ')')
        .call(calendarAxis);

    var calendarRowUpdate = PLAYGROUND.selectAll(".calendar-row")
        .data(calendarRowY);

    var calendarRowEnter = calendarRowUpdate.enter()
      .append('g')
        .attr('class', 'calendar-row')
        .attr(
          'transform',
          function(d, i) {
            // console.log('Y: ' + CALENDAR_Y_SCALE(i))
            return 'translate(0, ' + d + ')'
            }
          );

    var calendarMonthUpdate = calendarRowEnter.selectAll(".calendar-month")
        .data(Array(CALENDAR_X_SCALE.domain().length).fill(0));

    var calendarMonthEnter = calendarMonthUpdate.enter()
      .append('text')
        .attr('class', 'calendar-month')
        .attr(
          'transform',
          function(d, i) {
            console.log('X: ' + CALENDAR_X_SCALE(i))
            return 'translate(' + (CALENDAR_X_SCALE(i) + 8) + ', 0)'
            }
          )
        .text(function(d, i) {return MONTHSTARTS[i]['month']});


    // for (var nMonthStart = 0; nMonthStart < MONTHSTARTS.length; nMonthStart++) {

    //   PLAYGROUND.append('g')
    //       .attr("class", "calendar axis")
    //       .attr('transform', 'translate(0, ' + gridBottom + ')')
    //       .call(calendarAxis);
    //   }

    }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // Axes setup.
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  function populateAxes() {

    // A horizontal axis.
    var x_axis = d3.axisTop(BAR_WIDTH)
      .tickSize(0);
      // .ticks(8);

    d3.select('#playground')
        .attr('class', 'axis')
        // .attr('width', 300)
        // .attr('height', 30)
      .append("g")
        .attr('transform', 'translate(0, 20)')
        .call(x_axis);

    }

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // Menu change handler callback.
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  function menuSelection() {
    // console.log("CHANGE CALLED");
    redraw()
    }

  </script>

<!-- - - - - - - - - - - - - - -  END SCRIPT  - - - - - - - - - - - - - - -->

  </body>
</html>
